syntax = "proto3";

package media;

option go_package = "social-network/shared/gen/media;media";

// Upload request
message UploadImageRequest {
  bytes file_content = 1;   // Raw file bytes
  string filename = 2;      // Original file name
}

// Upload response
message UploadImageResponse {
  int64 id = 1;            
  string mime_type = 2;     // Detected MIME type
  int64 size_bytes = 3;     // File size
  string bucket = 4;        // MinIO bucket
  string object_key = 5;    // MinIO object key
}

// Service definition
// Current behavior:
// - UploadImage: returns UNKNOWN on storage errors (fmt.Errorf), no explicit validation errors.
// - RetrieveImage: NOT_FOUND when image lookup fails; INTERNAL for stream/meta errors.
// Desired (not yet implemented):
// - INVALID_ARGUMENT for missing bytes/filename or unsupported mime type.
// - UNAUTHENTICATED/PERMISSION_DENIED when authz is enforced.
// - RESOURCE_EXHAUSTED for oversized files.
service MediaService {
  // Uploads an image and returns stored metadata.
  // Returns Error: UNKNOWN on storage errors. Desired: INVALID_ARGUMENT/RESOURCE_EXHAUSTED and authz codes as applicable.
  rpc UploadImage(UploadImageRequest) returns (UploadImageResponse);

  // Streams image metadata first, followed by file chunks.
  // Returns Error: NOT_FOUND if image_id is unknown; INTERNAL for streaming failures. Desired: PERMISSION_DENIED when access is restricted.
  rpc RetrieveImage(RetrieveImageRequest) returns (stream RetrieveImageResponse);
}

// Request
message RetrieveImageRequest {
  int64 image_id = 1;
}

// Metadata â€” mirrors your ImageMeta struct
message ImageMeta {
  int64 id = 1;
  string filename = 2;
  string mime_type = 3;
  int64 size_bytes = 4;
  string bucket = 5;
  string object_key = 6;
}

// File chunk
message ImageChunk {
  bytes data = 1; // raw bytes
}

// The streamed response
message RetrieveImageResponse {
  oneof payload {
    ImageMeta meta = 1;
    ImageChunk chunk = 2;
  }
}
